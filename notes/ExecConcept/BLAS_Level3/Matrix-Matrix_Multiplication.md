# Matrix-Matrix Multiplication Note

BLASEngineは行列積C=ABをサポートしています。
下図は披乗算行列Aの要素aと乗算側行列Bの要素bの間の対応を示しています。
左に行列Bの要素、右に行列Aの要素が位置しています。
要素bは各タイミングで要素aと合流して乗算を行い、累和を下方向へ転送します。
累和の方法は二つあります。
一つは乗算の後に列方向から受け取ったデータとで加算を行い結果を転送して出力段で内積結果の要素cを得る方法です。
もう一つは乗算結果をそのまま転送して各列の出力段にアキュムレータ（累和器）を設けておいてそこで累和を行い内積結果の要素cを得る方法です。


<div align="center">
  <img src="https://github.com/IAMAl/BLASEngine/blob/main/notes/ExecConcept/figures/MatMatMult.png"
       alt="HTML image alt text"
       title="Matrix-Matrix Multiplication"
       width="600px"
  />
</div>


この行列演算をBLASEngine上で実装する方法は二つあります。

#### 方法1：AとBを固定

行列AとBの要素は各レーンで固定した配置とします。
これは上図での横方向の各行がレーンに相当します。
乗算結果をネットワークを通して適切なレーンへローテートを通して転送し転送先レーンで累和に使用します。
これはシストリックアレイ演算に相当します。
このためインデックスユニット内の遅延回路を使用してイニシエートインターバルをエミュレートします。
転地したBの場合結果の行列Cも転地した配置で得ます。
この演算では三項演算（MAD）を前提とします。


#### 方法2：AとBをローテート

もう一つの方法は上図を例にすると要素aの列方向にレーンをマップします。
行列Aと行列Bの要素をレジスタファイルから読み出し、ネットワークでローテートを行い、適宜転送先レーンの乗算でも使用しデータを再利用します。
各レーンは一つの内積演算を実施して行列演算結果の要素cを得ます。
この演算も三項演算（MAD）を前提とします。


#### 多次元並列処理

上記の方法は図の例で3つのレーンを利用して演算しています。
これを9個のレーンを使用して行列の二次元をレーンに展開して上記の要領で演算することで二次元シストリックアレイでの行列積と同等の性能を実現できます。


#### BLASEngineのメリット

各レーンにある入力ベクトルの部分ベクトルを再配置する必要がなくなり、例えば次の演算において現在の演算結果ベクトルの各要素を各レーンへ再配置することを不要としてベクトル演算ユニットの演算器は演算のみに集中でき、無駄な処理を削減します。