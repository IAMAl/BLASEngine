# TPU Register Map Note

下の図はTPUのレジスタマップを示します。
レジスタのセットはスカラユニットとベクトルユニットで大別できます。
ベクトルユニットはレーン数の分マップを持ちます。
スカラとベクトルレーンのレジスタマップ上共通部分はレジスタファイル、Pレジスタ、そして状態レジスタです。

レジスタファイルは二つに分割されています。
各レジスタファイルは2リードポート、1ライトポートの構成です。
スライシングを用いる場合は二つのうちどちらか一方に適用され複数のレジスタファイルを横断するような読み書きはできません。


<div align="center">
  <img src="./TPU_RegisterMap.png"
       alt="HTML image alt text"
       title="TPUレジスタマップ"
       width="￥￥100px"
  />
</div>


状態レジスタ（Statusレジスタ）は比較結果や演算時の状態を保持します。
スカラユニットでは分岐命令により状態レジスタを参照して分岐条件とともに評価を行いPC値を更新します。
ベクトルレーンでは比較命令により状態レジスタを参照しながらスライシング時にマスクレジスタへ順次書き込んでいきます。
分岐命令でそのマスクレジスタ内容の評価方法を決めます。
マスクを利用した命令実行を指示する命令の発行後、各ベクトルレーンでの以降の命令はそのマスクレジスタの値に従って個々の命令を実行するかしないかを決めます。
そしてマスクを利用しない命令実行を指示する命令発行と共に以降の命令はマスクデータを条件とせず通常の実行を行います。

スカラユニットとベクトルレーンは演算ユニット内のパイプラインレジスタ（Pレジスタ）へアクセスできます。
移動命令で累和のような自己参照演算の初期値をそのレジスタへ書き込んだり、結果を読み出したりできるようにします。

スカラユニットはマスクレジスタを持っていますが、これはベクトルレーンでのレジスタファイル読み書きのマスクフラグで構成されています。
マスクレジスタは読み出しマスクと書き込みフラグの二つで構成されていて各ビット位置は各ベクトルレーンに対応しています。
各読み出しマスクフラグと各ベクトルレーンの命令内の読み出し有効フラグ、各書き込みマスクフラグと各ベクトルレーンの命令内の書き込み有効フラグをマスクすることで読み書きを有効・無効にできます。
また、ベクトルユニット内の全てのレーンの使用許可を制御するレジスタLane_Enレジスタを持っています。
このレジスタの各ビットは各レーンと一対一に対応していて、フラグをセットすることで対応するレーンでのパイプライン動作を制御します。
これにより実行に不要なレーンの動作を停止させることができます。
例えばこれはリダクション演算でツリー構成のデータフローを実現する際に使用します。

スカラユニットが制御フローを決めますがコール及びリターン命令はありません。
これはソフトウェアを実行するのではなく数値演算を行うカーネルの一つのスレッドを実行することを前提としているからです。